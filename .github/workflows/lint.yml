name: Lint

on:
  pull_request:
    paths:
      - '**.py'
      - '**.yaml'
      - '**.yml'
      - 'Dockerfile*'
      - '.github/workflows/**'

jobs:
  dockerfile:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: error
          format: sarif
          output-file: hadolint-results.sarif

      - name: Upload Hadolint results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: hadolint-results.sarif

  python:
    name: Python Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install ruff pylint

      - name: Run Ruff
        run: |
          ruff check bots/bots/ scripts/ --output-format=github

      - name: Run Pylint
        run: |
          pylint bots/bots/ scripts/ --output-format=colorized
        continue-on-error: true

  yaml:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Kubernetes YAML
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: k3s/
          config_data: |
            extends: default
            rules:
              line-length:
                max: 120
                level: warning
              indentation:
                spaces: 2
              document-start: disable

      - name: Validate GitHub Workflows
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .github/workflows/
          strict: true

  markdown:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v15
        with:
          globs: |
            **/*.md
            !bots/
            !bots-plugins/
            !bots-grammars/

      - name: Check Markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.markdown-link-check.json'
        continue-on-error: true
