# Multi-Environment Deployment Guide

This guide covers deploying Bots-EDI across development, staging, and production environments using Kustomize overlays.

## Prerequisites

- kubectl configured with k3s cluster access
- kustomize (built into kubectl 1.14+)
- kubeseal CLI (optional, for sealed secrets)
- Access to Harbor registry: harbor.pminc.me/priv/bots-edi

## Quick Start

### Deploy Development Environment
```bash
cd /path/to/bots_edi

# Create namespace
kubectl apply -f k3s/overlays/dev/namespace.yaml

# Create secret (replace placeholder values)
kubectl create secret generic bots-edidb-secret \
  --from-literal=DB_NAME=botsedi_dev \
  --from-literal=DB_USER=botsedi_dev \
  --from-literal=DB_PASSWORD='your-dev-password' \
  --from-literal=DB_HOST=localhost \
  --from-literal=DB_PORT=3306 \
  --from-literal=DJANGO_SECRET_KEY='your-dev-secret-key' \
  -n edi-dev

# Deploy all resources
kubectl apply -k k3s/overlays/dev/

# Verify
kubectl get pods -n edi-dev
kubectl get ingress -n edi-dev
```

### Deploy Staging Environment
```bash
# Create namespace
kubectl apply -f k3s/overlays/staging/namespace.yaml

# Create secret
kubectl create secret generic bots-edidb-secret \
  --from-literal=DB_NAME=botsedi_staging \
  --from-literal=DB_USER=botsedi_staging \
  --from-literal=DB_PASSWORD='your-staging-password' \
  --from-literal=DB_HOST=kona.db.pminc.me \
  --from-literal=DB_PORT=3306 \
  --from-literal=DJANGO_SECRET_KEY='your-staging-secret-key' \
  -n edi-staging

# Deploy
kubectl apply -k k3s/overlays/staging/

# Verify
kubectl get pods -n edi-staging
```

### Deploy Production Environment
```bash
# Production uses existing 'edi' namespace
# Ensure namespace exists
kubectl get namespace edi || kubectl create namespace edi

# Create secret (use production credentials)
kubectl create secret generic bots-edidb-secret \
  --from-literal=DB_NAME=botsedi_data \
  --from-literal=DB_USER=botsedi \
  --from-literal=DB_PASSWORD='your-production-password' \
  --from-literal=DB_HOST=kona.db.pminc.me \
  --from-literal=DB_PORT=3306 \
  --from-literal=DJANGO_SECRET_KEY='your-production-secret-key' \
  -n edi

# Deploy
kubectl apply -k k3s/overlays/prod/

# Verify
kubectl get pods -n edi
kubectl get ingress -n edi
```

## Detailed Procedures

### 1. Generate Secret Values

#### Django SECRET_KEY
```bash
python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"
```

#### Random Password (50 characters)
```bash
openssl rand -base64 48
```

#### Store Safely
Save generated values in a password manager (1Password, LastPass, etc.) or external secret vault.

### 2. Using Sealed Secrets (GitOps Approach)

#### Install Sealed Secrets Controller
```bash
# Using kubectl
kubectl apply -f k3s/secrets/sealed-secrets-setup.yaml

# OR using Helm
helm repo add sealed-secrets https://bitnami-labs.github.io/sealed-secrets
helm install sealed-secrets sealed-secrets/sealed-secrets -n kube-system
```

#### Install kubeseal CLI
```bash
# macOS
brew install kubeseal

# Linux
wget https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/kubeseal-0.24.0-linux-amd64.tar.gz
tar xfz kubeseal-0.24.0-linux-amd64.tar.gz
sudo install -m 755 kubeseal /usr/local/bin/kubeseal
```

#### Create and Seal Secrets

**Development:**
```bash
# 1. Copy template to temp file
cp k3s/secrets/secret-template-dev.yaml /tmp/dev-secret.yaml

# 2. Edit and replace placeholder values
nano /tmp/dev-secret.yaml

# 3. Seal the secret
kubeseal -f /tmp/dev-secret.yaml \
  -w k3s/overlays/dev/sealed-secret.yaml \
  --namespace edi-dev

# 4. Delete unencrypted file
rm /tmp/dev-secret.yaml

# 5. Commit sealed secret to Git
git add k3s/overlays/dev/sealed-secret.yaml
git commit -m "Add dev sealed secret"
```

**Staging & Production:** Repeat with appropriate templates and namespaces.

#### Deploy with Sealed Secrets
```bash
# The sealed secret is included in overlay resources
kubectl apply -k k3s/overlays/dev/

# Verify unsealed secret was created
kubectl get secret bots-edidb-secret -n edi-dev
```

### 3. Environment Variables

Each environment has specific ConfigMaps generated by Kustomize:

**Development (edi-dev):**
- `BOTSENV=development`
- `LOG_LEVEL=DEBUG`
- `DB_HOST=localhost`

**Staging (edi-staging):**
- `BOTSENV=staging`
- `LOG_LEVEL=INFO`
- `DB_HOST=kona.db.pminc.me`
- `DB_NAME=botsedi_staging`

**Production (edi):**
- `BOTSENV=production`
- `LOG_LEVEL=INFO`
- `DB_HOST=kona.db.pminc.me`
- `DB_NAME=botsedi_data`

### 4. Step-by-Step Deployment

#### Initial Deployment

1. **Create namespace** (if not exists)
   ```bash
   kubectl apply -f k3s/overlays/dev/namespace.yaml
   ```

2. **Create or apply secrets**
   ```bash
   # Manual
   kubectl create secret generic bots-edidb-secret ... -n edi-dev
   
   # OR Sealed
   kubectl apply -f k3s/overlays/dev/sealed-secret.yaml
   ```

3. **Wait for secrets to be ready**
   ```bash
   kubectl wait --for=jsonpath='{.data.DB_PASSWORD}' \
     secret/bots-edidb-secret -n edi-dev --timeout=60s
   ```

4. **Deploy base resources**
   ```bash
   kubectl apply -k k3s/overlays/dev/
   ```

5. **Wait for DB initialization**
   ```bash
   kubectl wait --for=condition=complete \
     job/bots-db-init-dev -n edi-dev --timeout=5m
   ```

6. **Verify deployments are ready**
   ```bash
   kubectl wait --for=condition=available \
     deployment/bots-webserver-dev -n edi-dev --timeout=5m
   
   kubectl wait --for=condition=available \
     deployment/bots-jobqueue-dev -n edi-dev --timeout=5m
   ```

7. **Check ingress**
   ```bash
   kubectl get ingress -n edi-dev
   curl -k https://bots-edi-dev.pminc.me/health/ping
   ```

#### Update Deployment

1. **Update image tag** (done via CI/CD or manually)
   ```bash
   # Update kustomization.yaml image tag
   cd k3s/overlays/dev
   kustomize edit set image harbor.pminc.me/priv/bots-edi:new-tag
   
   # Apply changes
   kubectl apply -k .
   ```

2. **Update configuration**
   ```bash
   # Modify base ConfigMaps or overlay patches
   kubectl apply -k k3s/overlays/dev/
   
   # Restart pods to pick up new config
   kubectl rollout restart deployment/bots-webserver-dev -n edi-dev
   kubectl rollout restart deployment/bots-jobqueue-dev -n edi-dev
   ```

3. **Update secrets**
   ```bash
   # Delete old secret
   kubectl delete secret bots-edidb-secret -n edi-dev
   
   # Create new secret
   kubectl create secret generic bots-edidb-secret ... -n edi-dev
   
   # Restart deployments
   kubectl rollout restart deployment/bots-webserver-dev -n edi-dev
   kubectl rollout restart deployment/bots-jobqueue-dev -n edi-dev
   ```

### 5. Verification & Testing

#### Check Pod Status
```bash
kubectl get pods -n edi-dev -l app=bots-edi
kubectl describe pod -n edi-dev -l component=webserver
```

#### Check Logs
```bash
# Webserver
kubectl logs -n edi-dev -l component=webserver --tail=100 -f

# Jobqueue
kubectl logs -n edi-dev -l component=jobqueue --tail=100 -f

# Engine CronJob (latest run)
kubectl logs -n edi-dev job/bots-engine-dev-<timestamp>
```

#### Test Health Endpoints
```bash
# Liveness
kubectl exec -n edi-dev deployment/bots-webserver-dev -- \
  curl -f http://localhost:8080/health/live

# Readiness
kubectl exec -n edi-dev deployment/bots-webserver-dev -- \
  curl -f http://localhost:8080/health/ready

# Via ingress
curl https://bots-edi-dev.pminc.me/health/ping
```

#### Check Database Connection
```bash
kubectl exec -n edi-dev deployment/bots-webserver-dev -- \
  python manage.py dbshell --command="SELECT COUNT(*) FROM routes;"
```

#### Check PVC Usage
```bash
kubectl exec -n edi-dev deployment/bots-webserver-dev -- df -h /home/bots/.bots
```

### 6. Rollback Procedures

#### Rollback Deployment
```bash
# View rollout history
kubectl rollout history deployment/bots-webserver-dev -n edi-dev

# Rollback to previous version
kubectl rollout undo deployment/bots-webserver-dev -n edi-dev

# Rollback to specific revision
kubectl rollout undo deployment/bots-webserver-dev -n edi-dev --to-revision=2
```

#### Rollback Configuration
```bash
# If using Git
git revert <commit-hash>
kubectl apply -k k3s/overlays/dev/
```

### 7. Scaling

#### Manual Scaling
```bash
# Scale webserver
kubectl scale deployment/bots-webserver-dev -n edi-dev --replicas=3

# Or update overlay and apply
# Edit k3s/overlays/dev/kustomization.yaml
kubectl apply -k k3s/overlays/dev/
```

#### Horizontal Pod Autoscaler (HPA)
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: bots-webserver-hpa
  namespace: edi-dev
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: bots-webserver-dev
  minReplicas: 1
  maxReplicas: 5
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
```

## CI/CD Integration

### Argo Events Sensor

The existing `k3s/sensor.yaml` triggers deployments on Git pushes to Harbor registry.

**For multi-environment:**

1. Create separate sensors per environment:
   - `sensor-dev.yaml` - Watches `harbor.pminc.me/priv/bots-edi:dev`
   - `sensor-staging.yaml` - Watches `harbor.pminc.me/priv/bots-edi:staging`
   - `sensor-prod.yaml` - Watches `harbor.pminc.me/priv/bots-edi:latest`

2. Update deployment targets in each sensor:
   ```yaml
   - name: update-deployment
     operation: update
     resource:
       namespace: edi-dev  # or edi-staging, edi
       group: apps
       version: v1
       resource: deployments
       name: bots-webserver-dev
   ```

### GitHub Actions Example

```yaml
name: Deploy to Staging
on:
  push:
    branches: [develop]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Deploy to staging
        run: |
          echo "${{ secrets.KUBECONFIG }}" > kubeconfig
          export KUBECONFIG=kubeconfig
          kubectl apply -k k3s/overlays/staging/
```

## Troubleshooting

### Pods not starting
```bash
# Check events
kubectl describe pod <pod-name> -n edi-dev

# Common issues:
# - Secret not found: Create secret first
# - Image pull error: Check registry credentials
# - PVC not bound: Check storage class and provisioner
```

### Database connection errors
```bash
# Verify secret values
kubectl get secret bots-edidb-secret -n edi-dev -o jsonpath='{.data.DB_HOST}' | base64 -d

# Test DB connectivity from pod
kubectl exec -n edi-dev deployment/bots-webserver-dev -- \
  nc -zv kona.db.pminc.me 3306
```

### Ingress not working
```bash
# Check ingress status
kubectl describe ingress bots-edi-ingress -n edi-dev

# Verify Traefik routes
kubectl get ingressroute -A

# Check DNS resolution
dig bots-edi-dev.pminc.me
```

### CronJob not running
```bash
# Check cronjob schedule
kubectl get cronjob -n edi-dev

# View job history
kubectl get jobs -n edi-dev -l app=bots-edi

# Check latest job logs
kubectl logs -n edi-dev job/<latest-job-name>
```

## Best Practices

1. **Always test in dev before staging/prod**
2. **Use sealed secrets for GitOps workflows**
3. **Tag images with specific versions, not :latest for prod**
4. **Monitor resource usage and adjust limits**
5. **Keep overlays DRY - use patches sparingly**
6. **Document environment-specific quirks**
7. **Automate deployments with CI/CD**
8. **Implement proper backup strategies**
9. **Test disaster recovery procedures**
10. **Maintain runbooks for common operations**

## Quick Reference

### Common Commands

```bash
# Deploy
kubectl apply -k k3s/overlays/<env>/

# Delete
kubectl delete -k k3s/overlays/<env>/

# View diff
kubectl diff -k k3s/overlays/<env>/

# Dry run
kubectl apply -k k3s/overlays/<env>/ --dry-run=client

# Build manifest
kustomize build k3s/overlays/<env>/ > manifest.yaml

# Restart all
kubectl rollout restart deployment -n <namespace>

# View logs (all pods)
kubectl logs -n <namespace> -l app=bots-edi --tail=100 -f

# Port forward (local testing)
kubectl port-forward -n <namespace> svc/bots-webserver 8080:8080
```

### Environment URLs

- **Development**: https://bots-edi-dev.pminc.me
- **Staging**: https://bots-edi-staging.pminc.me
- **Production**: https://bots-edi.pminc.me

### Namespaces

- **Development**: `edi-dev`
- **Staging**: `edi-staging`
- **Production**: `edi`

---

For detailed secret management, see [k3s/secrets/README.md](../secrets/README.md)  
For phase completion details, see [fork/phase5-complete.md](../../fork/phase5-complete.md)
